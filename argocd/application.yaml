# ============================================================
# ArgoCD Application Manifest for Demo App
# ============================================================
# WHO creates this file: YOU (the DevOps/Platform Engineer)
# WHERE it goes: Applied to the ArgoCD HUB cluster
# WHAT it does: Tells ArgoCD to watch the developer's GitHub repo
#               and auto-deploy whenever the image changes
# ============================================================

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: demo-app
  namespace: argocd   # Must be in the argocd namespace on the Hub cluster

  # ArgoCD Image Updater annotation:
  # Watches GHCR for new images tagged with "sha-*" and auto-deploys them
  annotations:
    argocd-image-updater.argoproj.io/image-list: demo-app=ghcr.io/REPLACE_GITHUB_USERNAME/demo-app
    argocd-image-updater.argoproj.io/demo-app.update-strategy: latest
    argocd-image-updater.argoproj.io/demo-app.tag-match: "^sha-"

spec:
  project: default

  source:
    # ðŸ“Œ The developer's GitHub repo (where their code + k8s/ manifests live)
    repoURL: https://github.com/REPLACE_GITHUB_USERNAME/demo-app-repo
    targetRevision: main
    path: k8s   # ArgoCD will deploy everything inside the k8s/ folder

  destination:
    # ðŸ“Œ The SPOKE cluster where the app will be deployed
    server: https://kubernetes.default.svc   # Use cluster name if deploying to a spoke
    namespace: demo-app

  syncPolicy:
    automated:
      prune: true      # Remove resources that are deleted from Git
      selfHeal: true   # If someone manually changes the cluster, revert it
    syncOptions:
      - CreateNamespace=true   # Auto-create the namespace if it doesn't exist
